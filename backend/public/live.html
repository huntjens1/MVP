<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Deepgram Direct Live Transcriptie Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 8px 16px; margin-right: 10px; }
        .log { background: #f0f0f0; border-radius: 6px; padding: 10px; margin: 20px 0; max-height: 180px; overflow-y: auto; font-size: 13px; }
        .final { color: #2563eb; font-weight: bold; }
        .interim { color: #999; font-style: italic; }
    </style>
</head>
<body>
    <h2>Deepgram Direct Live Transcriptie</h2>
    <button id="startBtn">Start opname</button>
    <button id="stopBtn" disabled>Stop opname</button>
    <div>
        <div id="status"></div>
        <div class="log" id="log"></div>
        <div class="final" id="final"></div>
        <div class="interim" id="interim"></div>
    </div>
    <script>
        let mediaRecorder, ws, audioStream;
        let isRecording = false;
        let DG_API_KEY = 'b0474b3fa55344c24b86c43633496470aec053c1'; // <<<<---- VUL HIER JOUW KEY IN

        function log(msg) {
            document.getElementById('log').textContent += msg + '\n';
            document.getElementById('log').scrollTop = 9999;
            console.log(msg);
        }

        document.getElementById('startBtn').onclick = async function() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('final').textContent = '';
            document.getElementById('interim').textContent = '';
            document.getElementById('log').textContent = '';
            isRecording = true;
            log('Opname starten...');
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm;codecs=opus' });

                // === Stap 1: Verbind direct naar Deepgram WS ===
                let deepgramWsUrl = `wss://api.deepgram.com/v1/listen?language=nl&punctuate=true&interim_results=true&encoding=opus&sample_rate=48000`;
                ws = new WebSocket(deepgramWsUrl, [], {
                    headers: { 'Authorization': 'Token ' + DG_API_KEY }
                });
                // workaround voor browser: voeg header toe in URL
                ws = new WebSocket(deepgramWsUrl, ['token', DG_API_KEY]);

                ws.onopen = () => {
                    log('✅ Verbonden met Deepgram WebSocket');
                    document.getElementById('status').textContent = 'Live transcriptie gestart!';
                    mediaRecorder.start(250); // 250ms chunks: meer latency = betrouwbaarder
                };

                ws.onclose = (e) => {
                    log('Deepgram WS gesloten: ' + e.code + ' / ' + e.reason);
                    document.getElementById('status').textContent = 'Verbinding met Deepgram gesloten.';
                    isRecording = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                };

                ws.onerror = (err) => {
                    log('WS error: ' + JSON.stringify(err));
                };

                // Ontvang live transcriptie
                ws.onmessage = function(event) {
                    let json;
                    try { json = JSON.parse(event.data); } catch { return; }
                    if (!json.channel) return;
                    if (json.channel.alternatives[0].transcript) {
                        let text = json.channel.alternatives[0].transcript;
                        if (json.is_final) {
                            document.getElementById('final').textContent += ' ' + text;
                            document.getElementById('interim').textContent = '';
                            // === STAP 2: Stuur transcriptie door naar eigen backend ===
                            fetch('/api/live-transcript', { // endpoint op je eigen backend!
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: 'testuser',        // Hier kun je user/tenant info meesturen
                                    tenantId: 'tenant1',
                                    transcript: text,
                                    isFinal: true,
                                    ts: Date.now(),
                                })
                            }).catch(e => log('Backend POST error: ' + e));
                        } else {
                            document.getElementById('interim').textContent = text;
                        }
                    }
                };

                // Stuur audio naar Deepgram
                mediaRecorder.ondataavailable = function(e) {
                    if (ws.readyState === 1 && e.data.size > 0) {
                        e.data.arrayBuffer().then(buf => ws.send(buf));
                    }
                };
            } catch (err) {
                log('❌ Fout: ' + err);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        };

        document.getElementById('stopBtn').onclick = function() {
            isRecording = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(t => t.stop());
            if (ws && ws.readyState === 1) ws.close();
            log('Opname gestopt.');
        };
    </script>
</body>
</html>
