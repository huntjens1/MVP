<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Deepgram Direct Live Transcriptie Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 8px 16px; margin-right: 10px; }
        .log { background: #f0f0f0; border-radius: 6px; padding: 10px; margin: 20px 0; max-height: 180px; overflow-y: auto; font-size: 13px; }
        .final { color: #2563eb; font-weight: bold; }
        .interim { color: #999; font-style: italic; }
    </style>
</head>
<body>
    <h2>Deepgram Direct Live Transcriptie</h2>
    <button id="startBtn">Start opname</button>
    <button id="stopBtn" disabled>Stop opname</button>
    <div>
        <div id="status"></div>
        <div class="log" id="log"></div>
        <div class="final" id="final"></div>
        <div class="interim" id="interim"></div>
    </div>
    <script>
        let mediaRecorder, ws, audioStream;
        let isRecording = false;

        function log(msg) {
            document.getElementById('log').textContent += msg + '\n';
            document.getElementById('log').scrollTop = 9999;
            console.log(msg);
        }

        async function getDeepgramToken() {
            const response = await fetch('/api/deepgram-token', { method: 'POST' });
            if (!response.ok) throw new Error("Kon geen Deepgram token ophalen");
            const data = await response.json();
            return data.token;
        }

        document.getElementById('startBtn').onclick = async function() {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('final').textContent = '';
            document.getElementById('interim').textContent = '';
            document.getElementById('log').textContent = '';
            isRecording = true;
            log('Opname starten...');
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm;codecs=opus' });

                // Ophalen token van backend
                log('Token opvragen...');
                const dgToken = await getDeepgramToken();
                log('Token ontvangen: ' + dgToken.substring(0,8) + '...');

                let deepgramWsUrl = 'wss://api.deepgram.com/v1/listen?language=nl&punctuate=true&interim_results=true&encoding=opus&sample_rate=48000';

                // BELANGRIJK: subprotocol is nu 'bearer'
                log('Openen Deepgram WS met browser-token (bearer)');
                ws = new WebSocket(deepgramWsUrl, ['bearer', dgToken]);

                ws.onopen = () => {
                    log('✅ Verbonden met Deepgram WebSocket');
                    document.getElementById('status').textContent = 'Live transcriptie gestart!';
                    mediaRecorder.start(250);
                };

                ws.onclose = (e) => {
                    log('Deepgram WS gesloten: ' + e.code + ' / ' + (e.reason || ''));
                    document.getElementById('status').textContent = 'Verbinding met Deepgram gesloten.';
                    isRecording = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                };

                ws.onerror = (err) => {
                    log('WS error: ' + JSON.stringify(err));
                };

                ws.onmessage = function(event) {
                    log('[DG WS] IN: ' + event.data);
                    let json;
                    try { json = JSON.parse(event.data); } catch { return; }
                    if (!json.channel) return;
                    if (json.channel.alternatives[0].transcript) {
                        let text = json.channel.alternatives[0].transcript;
                        if (json.is_final) {
                            document.getElementById('final').textContent += ' ' + text;
                            document.getElementById('interim').textContent = '';
                            fetch('/api/live-transcript', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: 'testuser',
                                    tenantId: 'tenant1',
                                    transcript: text,
                                    isFinal: true,
                                    ts: Date.now(),
                                })
                            })
                            .then(r => r.json())
                            .then(resp => log('[Backend] Response: ' + JSON.stringify(resp)))
                            .catch(e => log('Backend POST error: ' + e));
                        } else {
                            document.getElementById('interim').textContent = text;
                        }
                    }
                };

                mediaRecorder.ondataavailable = function(e) {
                    log("Audio chunk size:", e.data.size, "bytes");
                    if (ws.readyState === 1 && e.data.size > 0) {
                        e.data.arrayBuffer().then(buf => {
                            ws.send(buf);
                            log("Audio chunk verzonden naar Deepgram (" + buf.byteLength + " bytes)");
                        });
                    }
                };
            } catch (err) {
                log('❌ Fout: ' + err);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        };

        document.getElementById('stopBtn').onclick = function() {
            isRecording = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(t => t.stop());
            if (ws && ws.readyState === 1) ws.close();
            log('Opname gestopt.');
        };
    </script>
</body>
</html>
